

┌─────────────────────────────────────────────────────────────────┐
│                        VIRTUAL DEVICES                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  Sensor-1   │  │  Sensor-2   │  │  Sensor-3   │              │
│  │ Temperature │  │ Temperature │  │ Temperature │              │ 
│  │   Humidity  │  │   Humidity  │  │   Humidity  │              │ 
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                │                │                     │
│         └────────────────┼────────────────┘                     │
│                          │ MQTT/JSON                            │
│                          ▼                                      │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  │
┌─────────────────────────────────────────────────────────────────┐
│                    MQTT BROKER (EMQX)                           │
│                   ┌──────────────────┐                          │
│                   │   Topic:         │                          │
│                   │   iot/data/#     │                          │
│                   │   Port: 1883     │                          │
│                   └──────────────────┘                          │
│                          │ Subscribe                            │
│                          ▼                                      │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  │ MQTT Messages
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                 NODE.JS API SERVER                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    MQTT Handler                         │    │
│  │             - Subscribes to iot/data/#                  │    │
│  │             - Parses JSON payload                       │    │
│  │             - Batch inserts to DB                       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                          │ Prisma ORM                           │
│                          ▼                                      │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  │ SQL Queries
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                 TIMESCALEDB DATABASE                            │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                  Telemetry Table                        │    │
│  │  ┌─────────┬─────────┬─────────┬────────────┬─────────┐ │    │
│  │  │   ID    │  Time   │DeviceID │  Payload   │ Metadata│ │    │
│  │  │ (BigInt)│(DateTime)│ (String) │   (JSON)  │  (JSON)│ │    │
│  │  └─────────┴─────────┴─────────┴────────────┴─────────┘ │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  │ REST API
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                    CLIENT APPLICATIONS                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   REST API  │  │  Analytics  │  │   Metrics   │              │
│  │  /api/data  │  │ /api/analytics │ /api/metrics│              │
│  │ /api/query  │  │ /api/trend  │  │ /api/health │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘